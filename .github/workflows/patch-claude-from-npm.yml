name: Patch Claude From npm

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      package_version:
        description: "Optional @anthropic-ai/claude-code version (for example: 2.1.45). Leave empty for latest."
        required: false
        default: ""
      force:
        description: "Force patch/release even if base release exists (uses suffix tags like vX-2, vX-3)."
        required: false
        default: false
        type: boolean

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Resolve package spec
        id: spec
        run: |
          if [ -n "${{ github.event.inputs.package_version }}" ]; then
            echo "value=@anthropic-ai/claude-code@${{ github.event.inputs.package_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=@anthropic-ai/claude-code" >> "$GITHUB_OUTPUT"
          fi

      - name: Download and extract npm package
        id: extract
        run: |
          set -euo pipefail

          mkdir -p work/package-extract
          TARBALL="$(npm pack "${{ steps.spec.outputs.value }}" | tail -n1)"
          tar -xzf "$TARBALL" -C work/package-extract
          rm -f "$TARBALL"

          VERSION="$(jq -r .version work/package-extract/package/package.json)"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          CLI_PATH="$(find work/package-extract/package -type f -name 'cli.js' | head -n1)"
          if [ -z "$CLI_PATH" ]; then
            echo "Could not find cli.js in package contents."
            find work/package-extract/package -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          cp "$CLI_PATH" work/claude.original
          cp "$CLI_PATH" claude

          echo "cli_path=$CLI_PATH" >> "$GITHUB_OUTPUT"

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          FORCE_RELEASE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force || 'false' }}
        run: |
          set -euo pipefail

          VERSION="${{ steps.extract.outputs.version }}"
          BASE_TAG="v${VERSION}"
          TAG="$BASE_TAG"

          if gh release view "$BASE_TAG" > /dev/null 2>&1; then
            if [ "${FORCE_RELEASE}" = "true" ]; then
              SUFFIX=2
              TAG="${BASE_TAG}-${SUFFIX}"
              while gh release view "$TAG" > /dev/null 2>&1; do
                SUFFIX=$((SUFFIX + 1))
                TAG="${BASE_TAG}-${SUFFIX}"
              done

              echo "Release ${BASE_TAG} exists; forcing with tag ${TAG}."
              echo "skip=false" >> "$GITHUB_OUTPUT"
              echo "tag=$TAG" >> "$GITHUB_OUTPUT"
              echo "title=claude-code ${VERSION} (${TAG})" >> "$GITHUB_OUTPUT"
            else
              echo "Release ${BASE_TAG} already exists, skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "title=claude-code ${VERSION}" >> "$GITHUB_OUTPUT"
          fi

      - name: Apply display patches
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail
          bun patch-claude-display.js --file ./claude
          cp claude work/claude.patched

      - name: Write metadata
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail
          {
            echo "package_spec=${{ steps.spec.outputs.value }}"
            echo "source_cli_path=${{ steps.extract.outputs.cli_path }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
          } > work/metadata.txt

      - name: Create release
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.extract.outputs.version }}"
          TAG="${{ steps.check.outputs.tag }}"
          TITLE="${{ steps.check.outputs.title }}"

          gh release create "$TAG" \
            --title "$TITLE" \
            --notes "Patched from \`@anthropic-ai/claude-code@${VERSION}\`" \
            work/claude.original \
            work/claude.patched \
            work/metadata.txt
