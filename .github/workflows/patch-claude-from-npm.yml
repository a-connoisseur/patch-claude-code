name: Patch Claude From npm + native

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      package_version:
        description: "Optional @anthropic-ai/claude-code version (for example: 2.1.45). Leave empty for latest."
        required: false
        default: ""
      native_version:
        description: "Optional native installer version (for example: 2.1.59). Leave empty for latest."
        required: false
        default: ""
      force:
        description: "Force patch/release even if base release exists (uses suffix tags like vX-2, vX-3)."
        required: false
        default: false
        type: boolean

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      skip: ${{ steps.check.outputs.skip }}
      tag: ${{ steps.check.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Resolve package spec
        id: spec
        run: |
          if [ -n "${{ github.event.inputs.package_version }}" ]; then
            echo "value=@anthropic-ai/claude-code@${{ github.event.inputs.package_version }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=@anthropic-ai/claude-code" >> "$GITHUB_OUTPUT"
          fi

      - name: Download and extract npm package
        id: extract
        run: |
          set -euo pipefail

          mkdir -p work/package-extract
          TARBALL="$(npm pack "${{ steps.spec.outputs.value }}" | tail -n1)"
          tar -xzf "$TARBALL" -C work/package-extract
          rm -f "$TARBALL"

          VERSION="$(jq -r .version work/package-extract/package/package.json)"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          CLI_PATH="$(find work/package-extract/package -type f -name 'cli.js' | head -n1)"
          if [ -z "$CLI_PATH" ]; then
            echo "Could not find cli.js in package contents."
            find work/package-extract/package -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          cp "$CLI_PATH" work/claude.original
          cp "$CLI_PATH" claude

          echo "cli_path=$CLI_PATH" >> "$GITHUB_OUTPUT"

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          FORCE_RELEASE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force || 'false' }}
        run: |
          set -euo pipefail

          VERSION="${{ steps.extract.outputs.version }}"
          BASE_TAG="v${VERSION}"
          TAG="$BASE_TAG"

          if gh release view "$BASE_TAG" > /dev/null 2>&1; then
            if [ "${FORCE_RELEASE}" = "true" ]; then
              SUFFIX=2
              TAG="${BASE_TAG}-${SUFFIX}"
              while gh release view "$TAG" > /dev/null 2>&1; do
                SUFFIX=$((SUFFIX + 1))
                TAG="${BASE_TAG}-${SUFFIX}"
              done

              echo "Release ${BASE_TAG} exists; forcing with tag ${TAG}."
              echo "skip=false" >> "$GITHUB_OUTPUT"
              echo "tag=$TAG" >> "$GITHUB_OUTPUT"
              echo "title=claude-code ${VERSION} (${TAG})" >> "$GITHUB_OUTPUT"
            else
              echo "Release ${BASE_TAG} already exists, skipping."
              echo "skip=true" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "title=claude-code ${VERSION}" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Bun
        if: steps.check.outputs.skip != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Apply display patches
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail
          cp work/claude.original work/claude.patched
          node patch-claude-display.js --file ./work/claude.patched

          cp work/claude.original work/claude.no-inline-thinking.patched
          node patch-claude-display.js --file ./work/claude.no-inline-thinking.patched --disable thinking-inline

      - name: Build npm-native binaries (Linux)
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail

          tail -n +2 work/claude.patched > work/claude.patched.compile.js
          bun build --compile work/claude.patched.compile.js --outfile work/claude.npm-native.patched
          chmod +x work/claude.npm-native.patched
          ./work/claude.npm-native.patched --version

          tail -n +2 work/claude.no-inline-thinking.patched > work/claude.no-inline-thinking.compile.js
          bun build --compile work/claude.no-inline-thinking.compile.js --outfile work/claude.npm-native.no-thinking.patched
          chmod +x work/claude.npm-native.no-thinking.patched
          ./work/claude.npm-native.no-thinking.patched --version

      - name: Download native binary (Linux)
        if: steps.check.outputs.skip != 'true'
        id: native
        run: |
          set -euo pipefail

          mkdir -p work
          NATIVE_HOME="$PWD/work/native-home"
          mkdir -p "$NATIVE_HOME"

          curl -fsSL https://claude.ai/install.sh -o work/install-native.sh
          chmod +x work/install-native.sh

          if [ -n "${{ github.event.inputs.native_version }}" ]; then
            HOME="$NATIVE_HOME" bash work/install-native.sh "${{ github.event.inputs.native_version }}"
          else
            HOME="$NATIVE_HOME" bash work/install-native.sh
          fi

          NATIVE_BIN="$NATIVE_HOME/.local/bin/claude"
          if [ ! -x "$NATIVE_BIN" ]; then
            NATIVE_BIN="$(find "$NATIVE_HOME" -type f -name 'claude' -perm -111 | head -n1 || true)"
          fi

          if [ -z "$NATIVE_BIN" ] || [ ! -x "$NATIVE_BIN" ]; then
            echo "Could not locate installed native claude binary."
            find "$NATIVE_HOME" -maxdepth 6 -type f | head -n 200
            exit 1
          fi

          NATIVE_VERSION="$("$NATIVE_BIN" --version | head -n1 | awk '{print $1}')"
          echo "path=$NATIVE_BIN" >> "$GITHUB_OUTPUT"
          echo "version=$NATIVE_VERSION" >> "$GITHUB_OUTPUT"

          cp "$NATIVE_BIN" work/claude.native.original
          chmod +x work/claude.native.original

      - name: Apply display patches (native Linux)
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail

          cp work/claude.native.original work/claude.native.patched
          node patch-claude-display.js --file ./work/claude.native.patched
          ./work/claude.native.patched --version

          cp work/claude.native.original work/claude.native.no-inline-thinking.patched
          node patch-claude-display.js --file ./work/claude.native.no-inline-thinking.patched --disable thinking-inline
          ./work/claude.native.no-inline-thinking.patched --version

      - name: Write metadata
        if: steps.check.outputs.skip != 'true'
        run: |
          set -euo pipefail
          {
            echo "package_spec=${{ steps.spec.outputs.value }}"
            echo "source_cli_path=${{ steps.extract.outputs.cli_path }}"
            echo "native_install_script=https://claude.ai/install.sh"
            echo "native_version=${{ steps.native.outputs.version }}"
            echo "native_binary_path=${{ steps.native.outputs.path }}"
            echo "run_id=${{ github.run_id }}"
            echo "run_attempt=${{ github.run_attempt }}"
          } > work/metadata.txt

      - name: Create release
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.extract.outputs.version }}"
          NATIVE_VERSION="${{ steps.native.outputs.version }}"
          TAG="${{ steps.check.outputs.tag }}"
          TITLE="${{ steps.check.outputs.title }}"

          gh release create "$TAG" \
            --title "$TITLE" \
            --notes "Patched from \`@anthropic-ai/claude-code@${VERSION}\` and native Linux build \`${NATIVE_VERSION}\`" \
            work/metadata.txt \
            work/claude.original \
            work/claude.patched \
            work/claude.no-inline-thinking.patched \
            work/claude.npm-native.patched \
            work/claude.npm-native.no-thinking.patched \
            work/claude.native.original \
            work/claude.native.patched \
            work/claude.native.no-inline-thinking.patched

  patch-macos-native:
    needs: patch
    if: needs.patch.outputs.skip != 'true'
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Download patched npm assets from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p work
          TAG="${{ needs.patch.outputs.tag }}"

          gh release download "$TAG" \
            --pattern "claude.patched" \
            --pattern "claude.no-inline-thinking.patched" \
            --dir work \
            --clobber

      - name: Build npm-native binaries (macOS)
        run: |
          set -euo pipefail

          tail -n +2 work/claude.patched > work/claude.patched.compile.js
          bun build --compile --target bun-darwin-arm64 work/claude.patched.compile.js --outfile work/claude.npm-native.macos.patched
          codesign -f -s - ./work/claude.npm-native.macos.patched
          ./work/claude.npm-native.macos.patched --version

          tail -n +2 work/claude.no-inline-thinking.patched > work/claude.no-inline-thinking.compile.js
          bun build --compile --target bun-darwin-arm64 work/claude.no-inline-thinking.compile.js --outfile work/claude.npm-native.macos.no-thinking.patched
          codesign -f -s - ./work/claude.npm-native.macos.no-thinking.patched
          ./work/claude.npm-native.macos.no-thinking.patched --version

      - name: Download native binary (macOS)
        id: native_macos
        run: |
          set -euo pipefail

          mkdir -p work
          NATIVE_HOME="$PWD/work/native-home-macos"
          mkdir -p "$NATIVE_HOME"

          curl -fsSL https://claude.ai/install.sh -o work/install-native.sh
          chmod +x work/install-native.sh

          if [ -n "${{ github.event.inputs.native_version }}" ]; then
            HOME="$NATIVE_HOME" bash work/install-native.sh "${{ github.event.inputs.native_version }}"
          else
            HOME="$NATIVE_HOME" bash work/install-native.sh
          fi

          NATIVE_BIN="$NATIVE_HOME/.local/bin/claude"
          if [ ! -x "$NATIVE_BIN" ]; then
            NATIVE_BIN="$(find "$NATIVE_HOME" -type f -name 'claude' -perm -111 | head -n1 || true)"
          fi

          if [ -z "$NATIVE_BIN" ] || [ ! -x "$NATIVE_BIN" ]; then
            echo "Could not locate installed native macOS claude binary."
            find "$NATIVE_HOME" -maxdepth 6 -type f | head -n 200
            exit 1
          fi

          NATIVE_VERSION="$("$NATIVE_BIN" --version | head -n1 | awk '{print $1}')"
          echo "path=$NATIVE_BIN" >> "$GITHUB_OUTPUT"
          echo "version=$NATIVE_VERSION" >> "$GITHUB_OUTPUT"

          cp "$NATIVE_BIN" work/claude.native.macos.original
          chmod +x work/claude.native.macos.original

      - name: Apply display patches (native macOS)
        run: |
          set -euo pipefail

          cp work/claude.native.macos.original work/claude.native.macos.patched
          node patch-claude-display.js --file ./work/claude.native.macos.patched
          codesign -f -s - ./work/claude.native.macos.patched
          ./work/claude.native.macos.patched --version

          cp work/claude.native.macos.original work/claude.native.macos.no-inline-thinking.patched
          node patch-claude-display.js --file ./work/claude.native.macos.no-inline-thinking.patched --disable thinking-inline
          codesign -f -s - ./work/claude.native.macos.no-inline-thinking.patched
          ./work/claude.native.macos.no-inline-thinking.patched --version

      - name: Upload macOS native assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ needs.patch.outputs.tag }}"

          gh release upload "$TAG" \
            work/claude.native.macos.original \
            work/claude.native.macos.patched \
            work/claude.native.macos.no-inline-thinking.patched \
            work/claude.npm-native.macos.patched \
            work/claude.npm-native.macos.no-thinking.patched \
            --clobber
